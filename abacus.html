<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BrainiacGym - Pro Abacus</title>
    <style>
      :root {
        --primary: #f58220;
        --bg-color: #f8f9fa;
        --frame-inner: #2d3436;
        --rod-color: #b2bec3;
        --bead-heaven: #ff9f43;
        --bead-earth: #54a0ff;
      }

      * {
        box-sizing: border-box;
        user-select: none;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Roboto, sans-serif;
        background-color: var(--bg-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        /* UI FIX: Reduced top gap */
        padding-top: 70px;
      }

      /* --- Persistent Reload Button --- */
      .back-refresh-btn {
        position: fixed;
        top: 80px;
        left: 15px;
        z-index: 1000;
        background: #d63737;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      /* --- Compact Navbar --- */
      .navbar {
        height: 65px;
        background: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
      }
      .logo {
        height: 45px;
      }
      .logo-right {
        height: 40px;
      }

      /* --- Sleek Score Board --- */
      .score-board {
        background: white;
        padding: 15px;
        border-radius: 20px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        text-align: center;
        width: 95%;
        max-width: 500px;
        margin-bottom: 10px;
        border: 1px solid #eee;
        z-index: 100;
      }
      .score-label {
        font-size: 0.75rem;
        color: #777;
        text-transform: uppercase;
      }
      .score-value {
        font-size: 2.2rem;
        font-weight: 800;
        color: #2d3436;
        margin: 5px 0;
      }

      /* --- Control Panel --- */
      .controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 6px;
      }

      .btn-explore {
        display: inline-block;
        background-color: #f58220;
        color: white;
        text-decoration: none;
        padding: 15px 40px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 1rem;
        transition: all 0.3s ease;
        box-shadow: 0 10px 20px rgba(245, 130, 32, 0.3);
        margin-bottom: 30px;
      }

      .btn-explore:hover {
        transform: translateY(-3px);
        background-color: #e67e22;
        box-shadow: 0 15px 25px rgba(245, 130, 32, 0.4);
      }

      .btn {
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #ddd;
        background: white;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
      }
      .btn-move {
        color: var(--bead-earth);
      }
      .btn-clear {
        background: #2d3436;
        color: white;
        border: none;
      }

      /* --- FIXED SCROLLING CONTAINER --- */
      .abacus-scroll-container {
        width: 100%;
        overflow: auto;
        max-height: 75vh;
        /* UI FIX: Block + text-align ensures 50% scroll works and no left clipping */
        display: block;
        text-align: center;
        padding: 20px 0;
        -webkit-overflow-scrolling: touch;
      }
      .sub-title {
        color: #383e3f;
        font-size: 1.4rem;
        font-weight: 700;
        margin-top: 10px;
        margin-bottom: 15px;
      }

      /* --- ZOOM & TRANSFORMATION LAYER --- */
      .abacus-zoom-layer {
        display: inline-block;
        transition: transform 0.2s ease-out;
        padding: 100px; /* Buffer for rotation/scaling */
        transform-origin: center center;
      }

      .abacus-frame {
        background-color: var(--frame-inner);
        padding: 15px;
        border-radius: 12px;
        display: flex;
        gap: 10px;
        position: relative;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .beam {
        position: absolute;
        left: 0;
        right: 0;
        top: 85px;
        height: 12px;
        background: #636e72;
        z-index: 5;
      }

      .rod {
        width: 46px;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
      }
      .rod::before {
        content: "";
        position: absolute;
        top: -10px;
        bottom: -10px;
        width: 6px;
        background: var(--rod-color);
        border-radius: 3px;
      }

      .bead {
        width: 44px;
        height: 30px;
        border-radius: 10px;
        z-index: 10;
        cursor: pointer;
        transition: transform 0.2s;
        box-shadow: inset 0 4px 4px rgba(255, 255, 255, 0.2),
          0 4px 8px rgba(0, 0, 0, 0.2);
      }
      .bead.heaven {
        background: var(--bead-heaven);
        margin-bottom: 70px;
      }
      .bead.earth {
        background: var(--bead-earth);
        margin-top: 8px;
      }
      .rod .bead.earth:first-of-type {
        margin-top: 55px;
      }

      .bead.heaven.active {
        transform: translateY(35px);
      }
      .bead.earth.active {
        transform: translateY(-35px);
      }

      .rod-mark {
        position: absolute;
        top: 72px;
        width: 12px;
        height: 12px;
        background: #d63737;
        border-radius: 50%;
        z-index: 20;
      }

      /* --- About Us Section --- */
      .about-container {
        width: 90%;
        max-width: 800px;
        background: white;
        padding: 30px;
        margin: 40px auto;
        border-radius: 20px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }
      h2 {
        color: var(--primary);
      }
      p {
        color: #636e72;
        line-height: 1.6;
      }

      @media (max-width: 600px) {
        .logo-right {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <button class="back-refresh-btn" onclick="location.reload()">←BACK</button>
    <header class="navbar">
      <img
        src="https://brainiacgym.com/wp-content/uploads/2023/10/Brainiacgym-Final-1.png"
        class="logo"
        alt="Logo"
      />

      <a href="index.html" class="btn btn-clear">HOME</a>

      <img
        src="https://brainiacgym.com/wp-content/uploads/2025/10/Untitled-820-x-500-px.png"
        class="logo-right"
      />
    </header>

    <div class="score-board">
      <div class="score-label">Total Value</div>
      <div class="score-value" id="totalDisplay">0</div>

      <div class="controls">
        <button class="btn" onclick="rotateAbacus()">Rotate 90°</button>
        <button class="btn" onclick="changeScale(0.1)">+ Size</button>
        <button class="btn" onclick="changeScale(-0.1)">- Size</button>
        <button class="btn btn-clear" onclick="resetBeads()">
          Reset Abacus Work
        </button>
        <!-- <button class="btn btn-move" onclick="moveAbacus(-30, 0)">⬅️</button>
        <button class="btn btn-move" onclick="moveAbacus(30, 0)">➡️</button> -->
        <!-- <button class="btn btn-move" onclick="moveAbacus(0, -30)">⬆ UP</button>
        <button class="btn btn-move" onclick="moveAbacus(0, 30)">⬇ DOWN</button> -->
        <button class="btn btn-clear" onclick="fitToScreen()">
          Fit Screen
        </button>
      </div>
    </div>

    <div class="abacus-scroll-container" id="scrollContainer">
      <div class="abacus-zoom-layer" id="zoomLayer">
        <div class="abacus-frame" id="abacusFrame">
          <div class="beam"></div>
        </div>
      </div>
    </div>

    <div class="about-container">
      <h2 class="section-title">About Us</h2>
      <p class="section-text">
        BrainiacGym is an academy of experienced professionals focusing on
        building curriculum skills of the children aged 6 to 16 years by
        offering unique & essential skill development programs in Abacus
        Training Course.
      </p>

      <a href="#" class="btn-explore">Explore Courses</a>

      <h3 class="sub-title">About BrainiacGym</h3>
      <p class="section-text">
        We are a team of talented & ambitious professionals who have come
        together to offer quality life by doing our utmost to shape the future
        of tomorrow. Along with the growth of Abacus interests in India, our
        interest in Education & Training laid the foundations of the BrainiacGym
        Academy in 2012 and we provide Abacus Training Course.
      </p>
      <p class="section-text">
        The BrainiacGym presents several courses and programs that will
        influence and substantially enhance your child’s brain.
      </p>
    </div>

    <script>
      const COLUMN_COUNT = 17;
      const abacusFrame = document.getElementById("abacusFrame");
      const totalDisplay = document.getElementById("totalDisplay");

      // PERSISTENCE: Load saved state or null for first-time calculation
      let currentScale =
        parseFloat(localStorage.getItem("abacusScale")) || null;
      let isRotated = localStorage.getItem("abacusRotated") === "true";
      let translateX = parseFloat(localStorage.getItem("abacusX")) || 0;
      let translateY = parseFloat(localStorage.getItem("abacusY")) || 0;

      function init() {
        for (let i = 0; i < COLUMN_COUNT; i++) {
          const rod = document.createElement("div");
          rod.className = "rod";
          if ((i + 1) % 3 === 0) {
            const mark = document.createElement("div");
            mark.className = "rod-mark";
            rod.appendChild(mark);
          }
          const heaven = document.createElement("div");
          heaven.className = "bead heaven";
          heaven.onclick = () => {
            heaven.classList.toggle("active");
            updateScore();
          };
          rod.appendChild(heaven);
          for (let j = 0; j < 4; j++) {
            const earth = document.createElement("div");
            earth.className = "bead earth";
            earth.onclick = () => toggleEarth(i, j);
            rod.appendChild(earth);
          }
          abacusFrame.appendChild(rod);
        }

        if (currentScale === null) fitToScreen();
        else applyTransform();

        // Centering logic
        setTimeout(centerAbacusScroll, 150);
      }

      function fitToScreen() {
        const totalWidth = COLUMN_COUNT * 46 + (COLUMN_COUNT - 1) * 10 + 60;
        const screenWidth = window.innerWidth - 40;
        currentScale = Math.min(screenWidth / totalWidth, 1.2);
        translateX = 0;
        translateY = 0;
        applyTransform();
        setTimeout(centerAbacusScroll, 100);
      }

      function centerAbacusScroll() {
        const container = document.getElementById("scrollContainer");
        container.scrollLeft =
          (container.scrollWidth - container.clientWidth) / 2;
      }

      function toggleEarth(rodIdx, beadIdx) {
        const rods = document.querySelectorAll(".rod");
        const beads = rods[rodIdx].querySelectorAll(".bead.earth");
        const isActive = beads[beadIdx].classList.contains("active");
        beads.forEach((b, i) => {
          if (!isActive) {
            if (i <= beadIdx) b.classList.add("active");
          } else {
            if (i >= beadIdx) b.classList.remove("active");
          }
        });
        updateScore();
      }

      function updateScore() {
    const rods = document.querySelectorAll(".rod");
    let total = BigInt(0);
    
    // 1. Map all rod values (0-9) into an array
    let values = Array.from(rods).map((rod) => {
        let v = rod.querySelector(".heaven").classList.contains("active") ? 5 : 0;
        v += rod.querySelectorAll(".earth.active").length;
        return v;
    });

    // 2. Find the Rightmost Active Rod (highest index with a value > 0)
    let rightmostActive = -1;
    for (let i = values.length - 1; i >= 0; i--) {
        if (values[i] > 0) {
            rightmostActive = i;
            break; 
        }
    }

    // 3. Find the Leftmost Active Rod (to know where to start the loop)
    let leftmostActive = -1;
    for (let i = 0; i < values.length; i++) {
        if (values[i] > 0) {
            leftmostActive = i;
            break;
        }
    }

    if (rightmostActive !== -1) {
        // 4. Identify the "Units" Reference
        // We find the nearest red-dot rod that is at or to the right of our rightmost bead.
        // In your code, marks are at: 2, 5, 8, 11, 14
        let unitsIndex = 0;
        for (let i = rightmostActive; i < values.length; i++) {
            if ((i + 1) % 3 === 0) {
                unitsIndex = i;
                break;
            }
        }
        
        // If no red dot is found to the right, we default to the last rod (index 16)
        if (unitsIndex === 0) unitsIndex = values.length - 1;

        // 5. Calculate the total based on distance from that Units Index
        for (let i = leftmostActive; i <= rightmostActive; i++) {
            let power = unitsIndex - i;
            if (power >= 0) {
                // Standard calculation: rodValue * 10^(distance from units rod)
                total += BigInt(values[i]) * (10n ** BigInt(power));
            } else {
                // This handles if beads are moved to the RIGHT of the units rod (decimals)
                // For now, we will treat them as 0 or ignore to keep it simple as per your request
                continue; 
            }
        }
    }

    totalDisplay.innerText = total.toLocaleString();
}

      function rotateAbacus() {
        isRotated = !isRotated;
        applyTransform();
      }
      function changeScale(amt) {
        currentScale = Math.min(Math.max(0.2, currentScale + amt), 3.0);
        applyTransform();
      }
      function moveAbacus(x, y) {
        translateX += x;
        translateY += y;
        applyTransform();
      }
      function resetBeads() {
        document
          .querySelectorAll(".bead")
          .forEach((b) => b.classList.remove("active"));
        updateScore();
      }

      function applyTransform() {
        const layer = document.getElementById("zoomLayer");
        const container = document.getElementById("scrollContainer");

        const rot = isRotated ? "rotate(90deg)" : "rotate(0deg)";
        layer.style.transform = `translate(${translateX}px, ${translateY}px) ${rot} scale(${currentScale})`;

        // PERSISTENCE: Save to localStorage
        localStorage.setItem("abacusScale", currentScale);
        localStorage.setItem("abacusRotated", isRotated);
        localStorage.setItem("abacusX", translateX);
        localStorage.setItem("abacusY", translateY);

        // VERTICAL SCROLL FIX: Adjust container height when rotated
        if (isRotated) {
          const frameWidth = abacusFrame.offsetWidth * currentScale;
          container.style.minHeight = frameWidth + 250 + "px";
        } else {
          container.style.minHeight = "auto";
        }
      }

      init();
    </script>
  </body>
</html>
